<!DOCTYPE html>
<html lang='en'>
<html>
<head>
    <meta charset='utf-8'/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Calendar{% endblock %}</title>
    {% block stylesheets %}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@4.4.2/main.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@4.4.2/main.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@4.4.2/main.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <style>
            .modal-header, h4, .close {
                background-color: #5cb85c;
                color: white !important;
                text-align: center;
                font-size: 30px;
            }

            .modal-footer {
                background-color: #f9f9f9;
            }

            option:disabled {
                color: #ff0000;
            }

            option:default {
                color: #808080;
            }
        </style>
    {% endblock %}

    {% block javascripts %}
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@4.4.2/main.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@4.4.2/main.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@4.4.2/main.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@4.4.2/main.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script>

            var events = [], eventsA = [], eventsB = [], eventsC = [], busyTimes = [];
            var dayClicked = false;
            var specialist, clickedDay;

            document.addEventListener('DOMContentLoaded', function () {

                if (document.getElementById("specialist").value === 'Wybierz specjaliste') {
                    sessionStorage.removeItem('specialist');
                } else {
                    specialist = sessionStorage.getItem("specialist");
                }


                let js_events = {{ events|json_encode|raw }};
                js_events.forEach(function (js_events) {
                    if (typeof js_events.attendees !== 'undefined') {
                        if (js_events.attendees[0].email === "danielspraktyka@gmail.com" || js_events.attendees[1].email === "danielspraktyka@gmail.com") {
                            eventsA.push({
                                title: js_events.summary,
                                start: js_events.start.dateTime,
                                end: js_events.end.dateTime,
                                color: 'orange',
                            })
                        }
                        ;
                        if (js_events.attendees[0].email === "danielspraktyka2@gmail.com" || js_events.attendees[1].email === "danielspraktyka2@gmail.com") {
                            eventsB.push({
                                title: js_events.summary,
                                start: js_events.start.dateTime,
                                end: js_events.end.dateTime,
                                color: 'green',
                            })
                        }
                        ;
                        if (js_events.attendees[0].email === "danielspraktyka3@gmail.com" || js_events.attendees[1].email === "danielspraktyka3@gmail.com") {
                            eventsC.push({
                                title: js_events.summary,
                                start: js_events.start.dateTime,
                                end: js_events.end.dateTime,
                                color: 'red',
                            })
                        }
                        ;
                    }

                });
                if (specialist === 'danielspraktyka@gmail.com') {
                    events = eventsA;
                }
                if (specialist === 'danielspraktyka2@gmail.com') {
                    events = eventsB;
                }
                if (specialist === 'danielspraktyka3@gmail.com') {
                    events = eventsC;
                }

                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    defaultView: 'dayGridMonth',
                    locale: 'pl',
                    editable: false,
                    firstDay: 1,
                    slotDuration: '01:00',
                    slotMinTime: "10:00:00",
                    slotMaxTime: "18:00:00",
                    unselectAuto: true,
                    eventTimeFormat: { // like '14:30:00'
                        hour: '2-digit',
                        minute: '2-digit',
                        //second: '2-digit',
                        meridiem: false,
                    },
                    displayEventEnd: true,
                    businessHours: {
                        // days of week. an array of zero-based day of week integers (0=Sunday)
                        daysOfWeek: [1, 2, 3, 4, 5], // Monday - Thursday
                        startTime: '10:00', // a start time (10am in this example)
                        endTime: '18:00', // an end time (6pm in this example)
                    },
                    header: {
                        left: 'prev,next today myCustomButton Lista',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay',
                    },
                    googleCalendarApiKey: 'AIzaSyBvc5Y3UcDZvHF8Myl3PCwFi8-xQPCTSDc',
                    events: events,
                    plugins: ['interaction', 'dayGrid', 'timeGrid'], // https://fullcalendar.io/docs/plugin-index
                    selectable: true,
                    selectMirror: true,
                    dateClick: function (info) {
                        if (document.getElementById("specialist").value === 'Wybierz specjaliste') {
                            calendar.unselect()
                            alert("Najpierw wybierz specjaliste do którego chcesz się zarejestrować!")
                        } else {

                            clickedDay = info.dateStr;
                            let clickedDayDate = new Date(clickedDay);
                            let currDate = calendar.getDate().getDate();

                            if (clickedDayDate.getDate() < currDate) {
                                alert("Nie możesz wybrać przeszłej daty!")
                            } else {

                                console.log(events);

                                events.forEach(function (events) {
                                    if (clickedDay === events.start.slice(0, 10)) {
                                        busyTimes.push(events.start.slice(11, 16));
                                    }
                                });
                                console.log(busyTimes);
                                console.log(events[0].start.slice(0, 10));
                                console.log(clickedDay);

                                //$("#time").each(function(idx, element) {
                                busyTimes.forEach(function (busyTime) {
                                    $('#time option[value="' + busyTime + '"]').prop('disabled', true);
                                    console.log(busyTime);
                                });

                                $(document).ready(function () {
                                    PlaceholdersModal();
                                    $("#myModal").modal();
                                });
                                busyTimes = [];
                            }
                        }
                    }
                });
                calendar.render();
                calendar.unselect()
            });
            console.log(eventsA);

            function changeSpecialist() {
                // let temp = document.querySelector('#specialist');
                let temp = document.getElementById("specialist").value;
                console.log(temp);
                //document.getElementById("form").submit();
                if (temp === "SpecjalistaA") {
                    sessionStorage.setItem("specialist", "danielspraktyka@gmail.com");
                }
                if (temp === "SpecjalistaB") {
                    sessionStorage.setItem("specialist", "danielspraktyka2@gmail.com");
                }
                if (temp === "SpecjalistaC") {
                    sessionStorage.setItem("specialist", "danielspraktyka3@gmail.com");
                }

                location.reload();
            }

            //zapamietywanie wyboru specjalisty po refreshu
            var selectedProduct = sessionStorage.getItem("specialist");
            if (selectedProduct != undefined || selectedProduct != null) {
                $(".ProductDetails select").first().find(":selected").removeAttr("selected");
                $(".ProductDetails select").find("option").each(function () {
                    if ($(this).val() == selectedProduct) {
                        $(this).attr("selected", true);
                    }
                });
            }

            var specialistName;

            function PlaceholdersModal() {
                if (specialist === "danielspraktyka@gmail.com") {
                    specialistName = "dr Mariusz Pudzianowski";
                } else if (specialist === "danielspraktyka2@gmail.com") {
                    specialistName = "dr Adam Małysz";
                } else if (specialist === "danielspraktyka3@gmail.com") {
                    specialistName = "dr Jacek Krzynówek";
                }

                document.getElementById("spec").value = specialistName;
                document.getElementById("date").value = clickedDay;
            }
        </script>

    {% endblock %}

</head>
<body>
{% block body %}

    <div class="form">
        <form id="form" method="post">
            <label for="specialist">Wybierz specjalistę aby zobaczyć dostępne terminy: </label>

            <select id="specialist" name="specialist" onchange="changeSpecialist()">
                <option selected="default" disabled>Wybierz specjaliste</option>
                <option value="SpecjalistaA">dr Mariusz Pudzianowski</option>
                <option value="SpecjalistaB">dr Adam Małysz</option>
                <option value="SpecjalistaC">dr Jacek Krzynówek</option>
            </select>
        </form>
    </div>

    <div id="calendar"></div>

    {# ///////////////////////       MODAL      //////////////////////////////////// #}
    <div class="container">

        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header" style="padding:35px 50px;">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4><span class="glyphicon glyphicon-ok"></span> <b>Zarejestruj wizytę</b></h4>
                    </div>
                    <div class="modal-body" style="padding:40px 50px;">
                        <form role="form" method="post">
                            <div class="form-group">
                                <label for="spec"><span class="glyphicon glyphicon-user"></span> Wybrany
                                    specjalista</label>
                                <input type="text" name="specialist" class="form-control" id="spec" readonly>
                            </div>
                            <div class="form-group">
                                <label for="date"><span class="glyphicon glyphicon-calendar"></span> Wybrana
                                    data</label>
                                <input type="text" name="date" class="form-control" id="date" readonly>
                            </div>
                            <div class="form-group">
                                <label for="time"><span class="glyphicon glyphicon-time"></span> Wybierz godzine</label>
                                {# <input type="text" class="form-control" id="time" placeholder="Godzina"> #}
                                <select id="time" name="time" class="form-control" required>
                                    <option selected="default" disabled>Wybierz godzine</option>
                                    <option id="10" value="10:00">10:00-11:00</option>
                                    <option id="11" value="11:00">11:00-12:00</option>
                                    <option id="12" value="12:00">12:00-13:00</option>
                                    <option id="13" value="13:00">13:00-14:00</option>
                                    <option id="14" value="14:00">14:00-15:00</option>
                                    <option id="15" value="15:00">15:00-16:00</option>
                                    <option id="16" value="16:00">16:00-17:00</option>
                                    <option id="17" value="17:00">17:00-18:00</option>
                                </select>
                            </div>

                            <center><h3>Dane do rejestracji</h3></center>

                            <div class="form-group">
                                <label for="spec"><span class="glyphicon glyphicon-user"></span> Imię i nazwisko</label>
                                <input type="text" name="nameSurname" class="form-control" id="spec"
                                       placeholder='Wpisz imię i nazwisko' required>
                            </div>

                            <div class="form-group">
                                <label for="spec"><span class="glyphicon glyphicon-paperclip"></span> Email</label>
                                <input type="text" name="clientemail" class="form-control" id="spec"
                                       placeholder='Wpisz email' required>
                            </div>

                            <div class="form-group">
                                <label for="spec"><span class="glyphicon glyphicon-earphone"></span> Telefon kontaktowy</label>
                                <input type="tel" max="9" name="phoneNumber" class="form-control" id="spec"
                                       pattern="[0-9]{3}[0-9]{3}[0-9]{3}" placeholder='Wpisz telefon do kontaktu'
                                       required>
                            </div>
                            <button type="submit" name="register" class="btn btn-success btn-block"><span
                                        class="glyphicon glyphicon-credit-card"></span> Zarejestruj i zapłać
                            </button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger btn-default pull-left" data-dismiss="modal"><span
                                    class="glyphicon glyphicon-remove"></span> Cancel
                        </button>
                        {# <p>Not a member? <a href="#">Sign Up</a></p> #}
                        {# <p>Forgot <a href="#">Password?</a></p> #}
                    </div>
                </div>

            </div>
        </div>
    </div>
{% endblock %}
</body>
</html>